name: ğŸš€ Docker GPU Smoke Test

on:
  workflow_dispatch: # This adds the "Run workflow" button in GitHub UI

jobs:
  smoke-test:
    name: Build & Test Triton Kernels
    runs-on: [self-hosted, 3090] # Targets your specific machine
    
    steps:
      - name: ğŸ›°ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Build Docker Image
        run: |
          # Using a tag based on the commit helps avoid cache conflicts
          docker build -t ntp-train-test:${{ github.sha }} -f .devcontainer/Dockerfile .

      - name: ğŸï¸ Run Smoke Test (with GPU)
        run: |
          # --gpus all: Essential for Triton/Attention math on the 3090
          # --rm: Automatically clean up the container after it finishes
          docker run --rm --gpus all ntp-train-test:${{ github.sha }} \
            python main/train.py --smoke-test